#+title: Use fio to simulate ~irmin-pack.unix~ load

* Read performance
** Baseline ~irmin-pack.unix~ reads

#+begin_src ini :tangle baseline-reads.ini
[global]
rw=randread
filename=/home/adatario/dev/tclpa/.git/annex/objects/gx/17/SHA256E-s3691765475--13300581f2404cc24774da8615a5a3d3f0adb7d68c4c8034c4fa69e727706000/SHA256E-s3691765475--13300581f2404cc24774da8615a5a3d3f0adb7d68c4c8034c4fa69e727706000

[job1]
ioengine=psync
rw=randread
blocksize_range=50-300
size=3500000B
loops=100
#+end_src

#+begin_src shell :exports both :results output code
  fio baseline-reads.ini
#+end_src

#+RESULTS:
#+begin_src shell
job1: (g=0): rw=randread, bs=(R) 50B-300B, (W) 50B-300B, (T) 50B-300B, ioengine=psync, iodepth=1
fio-3.33
Starting 1 process

job1: (groupid=0, jobs=1): err= 0: pid=42484: Fri May 19 14:18:35 2023
  read: IOPS=230k, BW=29.8MiB/s (31.2MB/s)(334MiB/11209msec)
    clat (nsec): min=210, max=4069.4k, avg=4129.23, stdev=21131.34
     lat (nsec): min=230, max=4070.1k, avg=4154.08, stdev=21135.27
    clat percentiles (nsec):
     |  1.00th=[   221],  5.00th=[   231], 10.00th=[   231], 20.00th=[   231],
     | 30.00th=[   241], 40.00th=[   241], 50.00th=[   241], 60.00th=[   251],
     | 70.00th=[   310], 80.00th=[   330], 90.00th=[   362], 95.00th=[   612],
     | 99.00th=[123392], 99.50th=[130560], 99.90th=[136192], 99.95th=[136192],
     | 99.99th=[148480]
   bw (  KiB/s): min=27526, max=33845, per=99.84%, avg=30444.41, stdev=2900.78, samples=22
   iops        : min=207124, max=255516, avg=229381.59, stdev=22386.75, samples=22
  lat (nsec)   : 250=55.59%, 500=37.79%, 750=2.44%, 1000=0.65%
  lat (usec)   : 2=0.13%, 4=0.13%, 10=0.01%, 20=0.01%, 100=0.05%
  lat (usec)   : 250=3.23%, 500=0.01%, 750=0.01%
  lat (msec)   : 10=0.01%
  cpu          : usr=7.52%, sys=8.17%, ctx=84419, majf=0, minf=12
  IO depths    : 1=100.0%, 2=0.0%, 4=0.0%, 8=0.0%, 16=0.0%, 32=0.0%, >=64=0.0%
     submit    : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, >=64=0.0%
     complete  : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, >=64=0.0%
     issued rwts: total=2575300,0,0,0 short=0,0,0,0 dropped=0,0,0,0
     latency   : target=0, window=0, percentile=100.00%, depth=1

Run status group 0 (all jobs):
   READ: bw=29.8MiB/s (31.2MB/s), 29.8MiB/s-29.8MiB/s (31.2MB/s-31.2MB/s), io=334MiB (350MB), run=11209-11209msec

Disk stats (read/write):
    dm-1: ios=84008/120, merge=0/0, ticks=9396/0, in_queue=9396, util=94.84%, aggrios=84402/120, aggrmerge=0/0, aggrticks=9400/0, aggrin_queue=9400, aggrutil=94.70%
    dm-0: ios=84402/120, merge=0/0, ticks=9400/0, in_queue=9400, util=94.70%, aggrios=84402/99, aggrmerge=0/21, aggrticks=8827/5, aggrin_queue=8833, aggrutil=94.70%
  nvme0n1: ios=84402/99, merge=0/21, ticks=8827/5, in_queue=8833, util=94.70%
#+end_src

** Multiple Threads

Simulate multiple threads doing IO reads.

| Number of Threads | Read bandwidth (MiB/s) |
|-------------------+------------------------|
|                 1 |                   23.4 |
|                 2 |                   72.8 |
|                 3 |                    102 |
|                 4 |                    127 |
|                 5 |                    147 |
|                 6 |                    163 |
|                 7 |                    175 |
|                 8 |                    167 |
|                 9 |                    175 |
|                10 |                    172 |

TODO: write a script that does this automatically. For some reason I can't get division working in the fio job description file (https://fio.readthedocs.io/en/latest/fio_doc.html#job-file-parameters).

#+begin_src ini :tangle multiple-threads-pread.ini
[global]
rw=randread
filename=/home/adatario/dev/tclpa/.git/annex/objects/gx/17/SHA256E-s3691765475--13300581f2404cc24774da8615a5a3d3f0adb7d68c4c8034c4fa69e727706000/SHA256E-s3691765475--13300581f2404cc24774da8615a5a3d3f0adb7d68c4c8034c4fa69e727706000
loops=100
group_reporting
thread

[job1]
ioengine=psync
rw=randread
blocksize_range=50-300
size=350000
numjobs=10
#+end_src

#+begin_src shell :exports both :results output code
  fio multiple-threads-pread.ini
#+end_src

#+RESULTS:
#+begin_src shell
job1: (g=0): rw=randread, bs=(R) 50B-300B, (W) 50B-300B, (T) 50B-300B, ioengine=psync, iodepth=1
...
fio-3.33
Starting 10 threads

job1: (groupid=0, jobs=10): err= 0: pid=42511: Fri May 19 14:19:24 2023
  read: IOPS=1310k, BW=170MiB/s (179MB/s)(334MiB/1958msec)
    clat (nsec): min=210, max=4039.1k, avg=7158.23, stdev=39168.20
     lat (nsec): min=240, max=4040.0k, avg=7193.81, stdev=39168.62
    clat percentiles (nsec):
     |  1.00th=[   241],  5.00th=[   262], 10.00th=[   270], 20.00th=[   310],
     | 30.00th=[   322], 40.00th=[   342], 50.00th=[   382], 60.00th=[   442],
     | 70.00th=[   482], 80.00th=[   510], 90.00th=[   692], 95.00th=[   876],
     | 99.00th=[228352], 99.50th=[292864], 99.90th=[391168], 99.95th=[428032],
     | 99.99th=[501760]
   bw (  KiB/s): min=167714, max=183634, per=100.00%, avg=175624.67, stdev=785.55, samples=30
   iops        : min=1258470, max=1376786, avg=1316865.33, stdev=5793.59, samples=30
  lat (nsec)   : 250=2.39%, 500=73.15%, 750=17.48%, 1000=2.62%
  lat (usec)   : 2=0.38%, 4=0.02%, 10=0.08%, 20=0.06%, 50=0.19%
  lat (usec)   : 100=0.52%, 250=2.31%, 500=0.78%, 750=0.01%, 1000=0.01%
  lat (msec)   : 2=0.01%, 4=0.01%, 10=0.01%
  cpu          : usr=6.00%, sys=5.77%, ctx=104845, majf=0, minf=0
  IO depths    : 1=100.0%, 2=0.0%, 4=0.0%, 8=0.0%, 16=0.0%, 32=0.0%, >=64=0.0%
     submit    : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, >=64=0.0%
     complete  : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, >=64=0.0%
     issued rwts: total=2564400,0,0,0 short=0,0,0,0 dropped=0,0,0,0
     latency   : target=0, window=0, percentile=100.00%, depth=1

Run status group 0 (all jobs):
   READ: bw=170MiB/s (179MB/s), 170MiB/s-170MiB/s (179MB/s-179MB/s), io=334MiB (350MB), run=1958-1958msec

Disk stats (read/write):
    dm-1: ios=68914/0, merge=0/0, ticks=13516/0, in_queue=13516, util=95.30%, aggrios=70364/0, aggrmerge=0/0, aggrticks=13712/0, aggrin_queue=13712, aggrutil=94.69%
    dm-0: ios=70364/0, merge=0/0, ticks=13712/0, in_queue=13712, util=94.69%, aggrios=70364/0, aggrmerge=0/0, aggrticks=13470/0, aggrin_queue=13469, aggrutil=94.69%
  nvme0n1: ios=70364/0, merge=0/0, ticks=13470/0, in_queue=13469, util=94.69%
#+end_src

** Advice kernel about file access

#+begin_src ini :tangle fadvise-noreuse.ini
[global]
rw=randread
filename=/home/adatario/dev/tclpa/.git/annex/objects/gx/17/SHA256E-s3691765475--13300581f2404cc24774da8615a5a3d3f0adb7d68c4c8034c4fa69e727706000/SHA256E-s3691765475--13300581f2404cc24774da8615a5a3d3f0adb7d68c4c8034c4fa69e727706000

[job1]
ioengine=psync
rw=randread
blocksize_range=50-300
size=3500000B
loops=100
fadvise_hint=noreuse
#+end_src

#+begin_src shell :exports both :results output code
  fio fadvise-noreuse.ini
#+end_src

#+RESULTS:
#+begin_src shell
job1: (g=0): rw=randread, bs=(R) 50B-300B, (W) 50B-300B, (T) 50B-300B, ioengine=psync, iodepth=1
fio-3.35
Starting 1 process

job1: (groupid=0, jobs=1): err= 0: pid=14322: Mon Jun 12 10:50:49 2023
  read: IOPS=257k, BW=33.4MiB/s (35.0MB/s)(334MiB/9997msec)
    clat (nsec): min=200, max=3591.8k, avg=3673.08, stdev=23641.70
     lat (nsec): min=220, max=3592.6k, avg=3697.97, stdev=23651.94
    clat percentiles (nsec):
     |  1.00th=[   221],  5.00th=[   221], 10.00th=[   221], 20.00th=[   231],
     | 30.00th=[   241], 40.00th=[   282], 50.00th=[   322], 60.00th=[   330],
     | 70.00th=[   342], 80.00th=[   370], 90.00th=[   422], 95.00th=[   470],
     | 99.00th=[142336], 99.50th=[158720], 99.90th=[240640], 99.95th=[268288],
     | 99.99th=[468992]
   bw (  KiB/s): min=27551, max=39379, per=99.97%, avg=34181.32, stdev=2417.77, samples=19
   iops        : min=206942, max=294650, avg=257133.05, stdev=18535.04, samples=19
  lat (nsec)   : 250=36.52%, 500=58.76%, 750=1.43%, 1000=0.39%
  lat (usec)   : 2=0.43%, 4=0.11%, 10=0.09%, 20=0.03%, 50=0.01%
  lat (usec)   : 100=0.03%, 250=2.13%, 500=0.07%, 750=0.01%, 1000=0.01%
  lat (msec)   : 2=0.01%, 4=0.01%
  cpu          : usr=7.68%, sys=12.06%, ctx=57526, majf=0, minf=10
  IO depths    : 1=100.0%, 2=0.0%, 4=0.0%, 8=0.0%, 16=0.0%, 32=0.0%, >=64=0.0%
     submit    : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, >=64=0.0%
     complete  : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, >=64=0.0%
     issued rwts: total=2571200,0,0,0 short=0,0,0,0 dropped=0,0,0,0
     latency   : target=0, window=0, percentile=100.00%, depth=1

Run status group 0 (all jobs):
   READ: bw=33.4MiB/s (35.0MB/s), 33.4MiB/s-33.4MiB/s (35.0MB/s-35.0MB/s), io=334MiB (350MB), run=9997-9997msec

Disk stats (read/write):
    dm-1: ios=71901/52, merge=0/0, ticks=11476/4, in_queue=11480, util=91.44%, aggrios=72600/52, aggrmerge=0/0, aggrticks=11528/4, aggrin_queue=11532, aggrutil=91.27%
    dm-0: ios=72600/52, merge=0/0, ticks=11528/4, in_queue=11532, util=91.27%, aggrios=72600/33, aggrmerge=0/19, aggrticks=9739/8, aggrin_queue=9752, aggrutil=91.27%
  nvme0n1: ios=72600/33, merge=0/19, ticks=9739/8, in_queue=9752, util=91.27%
#+end_src

** io_uring

Just to see how fast one can go on modern hardware using asynchronous system APIs.

#+begin_src ini :tangle read-io_uring.ini
[global]
rw=randread
filename=/home/adatario/dev/tclpa/.git/annex/objects/gx/17/SHA256E-s3691765475--13300581f2404cc24774da8615a5a3d3f0adb7d68c4c8034c4fa69e727706000/SHA256E-s3691765475--13300581f2404cc24774da8615a5a3d3f0adb7d68c4c8034c4fa69e727706000
loops=100
group_reporting
thread

[job1]
ioengine=io_uring
iodepth=16
rw=randread
blocksize=64KiB
size=100MiB
numjobs=8
#+end_src

#+begin_src shell :exports both :results output code
  fio read-io_uring.ini
#+end_src

#+RESULTS:
#+begin_src shell
job1: (g=0): rw=randread, bs=(R) 62.5KiB-62.5KiB, (W) 62.5KiB-62.5KiB, (T) 62.5KiB-62.5KiB, ioengine=io_uring, iodepth=16
...
fio-3.33
Starting 8 threads

job1: (groupid=0, jobs=8): err= 0: pid=44365: Fri May 19 14:25:25 2023
  read: IOPS=147k, BW=8955MiB/s (9390MB/s)(74.5GiB/8517msec)
    slat (nsec): min=290, max=9700.4k, avg=9392.25, stdev=73806.67
    clat (nsec): min=130, max=23784k, avg=767189.99, stdev=1005905.48
     lat (usec): min=4, max=23786, avg=776.58, stdev=1007.13
    clat percentiles (usec):
     |  1.00th=[   17],  5.00th=[   30], 10.00th=[   43], 20.00th=[   62],
     | 30.00th=[   83], 40.00th=[  125], 50.00th=[  215], 60.00th=[  400],
     | 70.00th=[  914], 80.00th=[ 1795], 90.00th=[ 2278], 95.00th=[ 2606],
     | 99.00th=[ 3884], 99.50th=[ 4490], 99.90th=[ 6390], 99.95th=[ 7439],
     | 99.99th=[10028]
   bw (  MiB/s): min= 7688, max=10172, per=100.00%, avg=9047.06, stdev=83.12, samples=129
   iops        : min=125968, max=166674, avg=148226.72, stdev=1361.83, samples=129
  lat (nsec)   : 250=0.01%, 500=0.01%, 750=0.01%, 1000=0.01%
  lat (usec)   : 2=0.01%, 4=0.02%, 10=0.10%, 20=1.72%, 50=11.80%
  lat (usec)   : 100=21.71%, 250=17.36%, 500=10.21%, 750=4.71%, 1000=3.36%
  lat (msec)   : 2=12.41%, 4=15.67%, 10=0.88%, 20=0.01%, 50=0.01%
  cpu          : usr=2.68%, sys=14.62%, ctx=559563, majf=0, minf=0
  IO depths    : 1=0.1%, 2=0.1%, 4=0.3%, 8=0.5%, 16=99.0%, 32=0.0%, >=64=0.0%
     submit    : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, >=64=0.0%
     complete  : 0=0.0%, 4=99.9%, 8=0.0%, 16=0.1%, 32=0.0%, 64=0.0%, >=64=0.0%
     issued rwts: total=1249600,0,0,0 short=0,0,0,0 dropped=0,0,0,0
     latency   : target=0, window=0, percentile=100.00%, depth=16

Run status group 0 (all jobs):
   READ: bw=8955MiB/s (9390MB/s), 8955MiB/s-8955MiB/s (9390MB/s-9390MB/s), io=74.5GiB (80.0GB), run=8517-8517msec

Disk stats (read/write):
    dm-1: ios=345735/95, merge=0/0, ticks=597292/4, in_queue=597296, util=98.72%, aggrios=349972/95, aggrmerge=0/0, aggrticks=599656/4, aggrin_queue=599660, aggrutil=98.56%
    dm-0: ios=349972/95, merge=0/0, ticks=599656/4, in_queue=599660, util=98.56%, aggrios=349972/87, aggrmerge=0/8, aggrticks=542294/6, aggrin_queue=542303, aggrutil=97.77%
  nvme0n1: ios=349972/87, merge=0/8, ticks=542294/6, in_queue=542303, util=97.77%
#+end_src
